<!doctype html>
<html>
  <head>
    <title>RFK.id.au BrowserID Provisioning</title>
  </head>
  <body>
    <script type="text/javascript">
      var persona_server = "https://login.persona.org/";
      if (document.referrer) {
        persona_server = /^.*?:\/\/[^/]+\//.exec(document.referrer);
      }
      document.write('<script src="' + persona_server + 'provisioning_api.js"></scr' + 'ipt>');
    </script>
    <script src="http://code.jquery.com/jquery-1.8.1.min.js"></script>
    <script src="./bidbundle.js"></script>
    <script src="./personalIDP.js"></script>
    <script type="text/javascript">
    navigator.id.beginProvisioning(function(email, certDuration) {
        personalIDP.checkIfAuthenticated({
            "email": email,
            "error": function(err) {
                err = "user is not authenticated as target user";
                navigator.id.raiseProvisioningFailure(err);
            },
            "success": function() {
                navigator.id.genKeyPair(function(publicKey) {
                    personalIDP.generateCertificate({
                        "email": email,
                        "publicKey": publicKey,
                        "certDuration": certDuration,
                        "success": function (certificate) {
                            navigator.id.registerCertificate(certificate);
                        },
                        "error": function(err) {
                            navigator.id.raiseProvisioningFailure(err);
                        }
                    });
                });
            }
        });
    });
    </script>
  </body>
</html>
