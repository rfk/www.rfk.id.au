<!doctype html>
<html>
  <head>
    <title>RFK.id.au BrowserID Authentication</title>
  </head>
  <body>
    <script type="text/javascript">
      // Load the Persona javascript from whatever domain is accessing
      // this file.  It might be persona.org or anosrep.org or something
      // else entirely, and we want to work no matter which.
      var persona_server = "https://login.persona.org/";
      if (document.referrer && document.referrer.indexOf("persona.org") > 0) {
        persona_server = /^.*?:\/\/[^/]+\//.exec(document.referrer);
      }
      var script_url = persona_server + "authentication_api.js";
      document.write('<script src="' + script_url + '"></scr' + 'ipt>');
    </script>
    <script src="http://code.jquery.com/jquery-1.8.1.min.js"></script>
    <script src="./bidbundle.js"></script>
    <script src="./personalIDP.js"></script>
    <script type="text/javascript">

    // This is used to remember what email the user is trying to be.
    // It's currently not used for anything but it might be in future.
    var authEmail = null;

    // If we're already authenticated then there's no need to display the form.
    navigator.id.beginAuthentication(function(email) {
        authEmail = email;
        personalIDP.checkIfAuthenticated({
            "email": email,
            "success": function() {
                navigator.id.completeAuthentication();
            },
            "error": function() {
               $("#browserid-auth-form").show();
            }
        });
    });

    // If not, proceed with the form and set up a
    // callback to authenticate when it is submitted.
    $(function() {
       $("#browserid-auth-form").submit(function(evt) {
           evt.preventDefault();
           personalIDP.authenticate({
               "email": authEmail,
               "password": $("#browserid-auth-password").val(),
               "error": function(err) {
                    navigator.id.raiseAuthenticationFailure(err);
               },
               "success": function() {
                   navigator.id.completeAuthentication();
               }
           });
           return false;
       });
    });
    </script>
    <form id="browserid-auth-form" target="#" style="display: none">
    BrowserID Passphrase: <input type="password" id="browserid-auth-password" />
    <br/><input type="submit" value="Authenticate for BrowserID" />
    </form>
  </body>
</html>
