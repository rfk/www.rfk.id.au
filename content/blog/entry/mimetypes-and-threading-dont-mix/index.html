---
title: >
 Mimetypes and Threading don't mix
slug: mimetypes-and-threading-dont-mix
created: !!timestamp '2009-09-09 17:34:47.682179'
modified: !!timestamp '2009-09-09 17:34:47.682258'
tags: 
    - python
---

{% mark excerpt %}<p>I've just spent weeks (yes, <i>weeks</i>) battling a bug that turns out to have been caused by everyone's favourite broken stdlib module, <a href="http://docs.python.org/library/mimetypes.html">mimetypes</a>.  I'm far from the first to be bitten by this module's strangeness &ndash; Jacob Rus has compiled a long list of reasons why <a href="http://mail.python.org/pipermail/python-dev/2009-July/090928.html">the mimetypes module is pathologically broken</a>, while Armin Ronacher recently got a <a href="http://lucumr.pocoo.org/2009/3/1/the-1000-speedup-or-the-stdlib-sucks">1000% speedup</a> just by changing the way he imported things from the module (yes, <i>1000%</i>).</p>

<p>So consider this another little heads-up about the mimetypes module: <a href="http://bugs.python.org/issue5853">it doesn't play nice with threads.</a>.  If two threads call mimetypes.guess_type at the same time, and the module happens to need to initialise its internal database, then one of the threads will go into an infinite recursive loop and blow your stack.  What fun!</p>

<p>To be fair, the mimetypes module is slowly being converted into a healthy state, and this particular bug will be fixed in the next release.  But in the meantime, if you need to do mimetype guesswork in Python, make sure you do it very carefully.</p>{% endmark %}