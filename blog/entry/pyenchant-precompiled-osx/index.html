<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />

    <meta property="og:type" content="website">
    <meta property="og:url" content="https:&#x2F;&#x2F;www.rfk.id.au&#x2F;blog&#x2F;entry&#x2F;pyenchant-precompiled-osx&#x2F;" />

    <meta name="twitter:card" content="summary">
    <meta name="twitter:creator" content="@rfkelly">
    <meta name="twitter:site" content="@rfkelly">

    
      <meta name="twitter:title" content="PyEnchant: now with OSX!">
      <title>PyEnchant: now with OSX!</title>
    
    
    
    <link rel="icon" href="https:&#x2F;&#x2F;www.rfk.id.au&#x2F;processed_images&#x2F;92fe386560fb112700.png" />
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira Sans|Fira Mono">
    <link rel="stylesheet" href="https://www.rfk.id.au/main.css">
     
  </head>
  <body>
    
      <header>
        <a class="profile-icon" href="/">
          
          <img src="https:&#x2F;&#x2F;www.rfk.id.au&#x2F;processed_images&#x2F;92fe386560fb112700.png" alt="profile picture">
        </a>
        <nav>
            <a href="/about/">About</a>
            <a href="/blog/">Blog</a>
            <a href="https://github.com/rfk">GitHub</a>
            <a href="https://twitter.com/rfkelly">Twitter</a>
        </nav>
      </header>
    
    <main>
    
  <h1>PyEnchant: now with OSX!</h1>
  <div class="item-meta">
    
    <div class="item-date">August 17, 2010</div>
    
      <div class="item-tags">
        [ 
        
          <a href="https://www.rfk.id.au/tags/software/">software</a>
           | 
        
          <a href="https://www.rfk.id.au/tags/python/">python</a>
          
        
        ]
      </div>
    
    
  </div>

  <p>The latest release of <a href="http://www.rfk.id.au/software/pyenchant/">PyEnchant</a> now contains an experimental binary distribution for OSX, as both an mpkg installer and a python egg.  In theory, users on OSX 10.4 or later should be able to just drop <a href="http://pypi.python.org/packages/2.6/p/pyenchant/pyenchant-1.6.3-py2.6-macosx-10.4-universal.egg"><code>pyenchant-1.6.3-py2.6-macosx-10.4-universal.egg</code></a> somewhere on sys.path and be up and running and spellchecking with ease.</p>
<p>If you're a Mac user, please try it out and <a href="http://github.com/rfk/pyenchant/issues/">let me know</a> if anything doesn't work the way you expect.</p>
<span id="continue-reading"></span>
<p>The experience of building this was quite interesting, and more than a little painful, because I wanted to build a proper universal library that could be used on almost any Mac out there.  The gory details can be found in <a href="http://www.rfk.id.au/software/pyenchant/downloads/pyenchant-bdist-osx-sources-1.6.3.tar.gz">pyenchant-bdist-osx-sources-1.6.3.tar.gz</a>; this post is a quick set of notes that might help others get started.</p>
<p>Fortunately for me, the familiar build toolchain of <code>./configure; make; make install</code> is pretty much intact on OSX.  The only real trickery is getting the resulting library to work on systems other than your own.  I hit two major stumbling blocks in this regard:</p>
<ul>
<li>how to build <a href="http://en.wikipedia.org/wiki/Fat_binary">fat binaries</a> that still work on older versions of OSX?</li>
<li>how to make the libraries relocatable, so they can be installed at any location?</li>
</ul>
<p>This may all be old news to seasoned OSX veterans, but hopefully these notes can help out other expat linux users like me.</p>
<h2 id="fat-binaries-the-hard-way">Fat Binaries (the hard way)</h2>
<p>If you're lucky, building your lib into a fat binary will be easy: just add <code>-arch i386 -arch ppc -arch x86_64</code> to your CFLAGS and off you go.  But if the library's build scripts aren't prepared to handle multiple <code>-arch</code> options, or if you need to support older versions of OSX, then this will most likely fail.  PyEnchant's dependencies (mostly <a href="http://library.gnome.org/devel/glib/">glib</a>) failed on both counts, so instead I had to construct the fat binaries by hand.</p>
<p>To build libraries that work all the way back to OSX 10.4, you need to build against the 10.4u SDK. But there's a problem – the 10.4u SDK is missing 64-bit versions of several vital APIs.  The only way I could find to work around it was to compile the i386 and ppc versions of the library against the 10.4u SDK, compile the x86_64 version against the 10.5 SDK, then stitch them together into a custom fat binary.  Here are the basics of how it looks in the PyEnchant build script:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span># create three different compile trees for the three architectures.
</span><span>cp -r glib-2.24.1 glib-2.24.1.i386
</span><span>cp -r glib-2.24.1 glib-2.24.1.ppc
</span><span>cp -r glib-2.24.1 glib-2.24.1.x86_64
</span><span>
</span><span># compile the i386 and ppc versions against the 10.4u SDK
</span><span>cd glib-2.24.1.i386
</span><span>./configure CC=gcc-4.0 CFLAGS=&quot;-isysroot /Developer/SDKs/MacOSX10.4u.sdk -mmacosx-version-min=10.4 -arch i386&quot;
</span><span>make
</span><span>
</span><span>cd ../glib-2.24.1.ppc
</span><span>./configure CC=gcc-4.0 CFLAGS=&quot;-isysroot /Developer/SDKs/MacOSX10.4u.sdk -mmacosx-version-min=10.4 -arch ppc&quot;
</span><span>make
</span><span>
</span><span># compile the x86_64 version against the 10.5 SDK
</span><span>cd ../glib-2.24.1.x86_64
</span><span>./configure CC=gcc-4.0 CFLAGS=&quot;-isysroot /Developer/SDKs/MacOSX10.5.sdk -mmacosx-version-min=10.5 -arch x86_64&quot;
</span><span>make
</span><span>
</span><span># use lipo to stitch them all together
</span><span>lipo -create -arch i386 glib-2.24.1.i386/glib/.libs/libglib.dylib -arch ppc glib-2.24.1.ppc/glib/.libs/libglib.dylib \
</span><span>           -arch x86_64 glib-2.24.1.x86_64/glib/.libs/libglib.dylib -output ./libglib.dylib
</span></code></pre>
<p>Just to be sure, we can also use lipo to verify that the resulting library contains code for all three architectures:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$&gt; lipo -info ./libglib.dylib
</span><span>Architectures in the fat file: ./libglib.dylib are: i386 ppc x86_64
</span></code></pre>
<h2 id="relocatable-libraries">Relocatable Libraries</h2>
<p>If you take a peek inside the resulting dynamic libraries, you will see that they embed <em>absolute paths</em> at which they expect to find their runtime dependencies.  Here are the dependencies from the glib library after compiling using the trick above:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$&gt; otool -L ./build/lib/libglib-2.0.0.dylib
</span><span>./build/lib/libglib-2.0.0.dylib:
</span><span>        /Users/rfk/software/pyenchant/tools/pyenchant-bdist-osx-sources/build/lib/libglib-2.0.0.dylib (...snip...)
</span><span>        /System/Library/Frameworks/Carbon.framework/Versions/A/Carbon (...snip...)
</span><span>        /Users/rfk/software/pyenchant/tools/pyenchant-bdist-osx-sources/build/lib/libiconv.2.dylib (...snip...)
</span><span>        /Users/rfk/software/pyenchant/tools/pyenchant-bdist-osx-sources/build/lib/libintl.8.dylib (...snip...)
</span><span>        /usr/lib/libSystem.B.dylib (...snip...)
</span><span>        /usr/lib/libgcc_s.1.dylib (...snip...)
</span><span>        /System/Library/Frameworks/CoreServices.framework/Versions/A/CoreServices (...snip...)
</span><span>        /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation (...snip...)
</span></code></pre>
<p>While the libraries under <code>/usr</code> and <code>/System</code> aren't likely to go missing, the end-user is clearly not going to have anything installed under the <code>pyenchant-bdist-osx-sources</code> build directory! Shipped as is, this library will give linker errors on any machine but my own.</p>
<p>In the linux world we have the concept of an <a href="http://en.wikipedia.org/wiki/Rpath_%28linking%29">rpath</a>, which is a path embedded in the library telling the linker where to look for dependencies.  Crucially, the rpath can contain the string <code>${ORIGIN}</code> to specify paths relative to the installed location of the library.</p>
<p>Starting with 10.4, OSX has a similar facility called the &quot;loader path&quot;.  If you embed the string <code>@loader_path</code> into the dependency paths of your dynamic library, it will be replaced with the parent directory of the library or executable that is currently loading your lib.  This can <a href="http://lapcatsoftware.com/blog/2007/08/11/embedding-frameworks-in-loadable-bundles/">cause difficulties</a> when your library may be loaded from several different places, but for PyEnchant it is enough to get going.</p>
<p>In my <code>setup.py</code> file I use <a href="http://developer.apple.com/mac/library/documentation/Darwin/Reference/ManPages/man1/install_name_tool.1.html"><code>install_name_tool</code></a> to adjust these paths to the following:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$&gt; otool -L ./enchant/lib/libglib-2.0.0.dylib
</span><span>./enchant/lib/libglib-2.0.0.dylib:
</span><span>        @loader_path/libglib-2.0.0.dylib (...snip...)
</span><span>        /System/Library/Frameworks/Carbon.framework/Versions/A/Carbon (...snip...)
</span><span>        @loader_path/libiconv.2.dylib (...snip...)
</span><span>        @loader_path/libintl.8.dylib (...snip...)
</span><span>        /usr/lib/libSystem.B.dylib (...snip...)
</span><span>        /usr/lib/libgcc_s.1.dylib (...snip...)
</span><span>        /System/Library/Frameworks/CoreServices.framework/Versions/A/CoreServices (...snip...)
</span><span>        /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation (...snip...)
</span></code></pre>
<p>Now I can simply bundle all the required libraries into the &quot;lib&quot; directory of the enchant distribution, and they will all happily find each other at runtime.</p>
<p>This all seems to work for me on a 32-bit python running under 10.4, a 32-bit python running under 10.6, and the native 64-bit python that comes with 10.6.  Unfortunately I don't have a ppc Mac to test this on – any reports that it works (or otherwise) would be greatly appreciated.</p>


  <hr />

  <div class="related-pages">
    <div><a href="https:&#x2F;&#x2F;www.rfk.id.au&#x2F;blog&#x2F;entry&#x2F;hatchet-hack-frozen-pyside-apps&#x2F;">Hatchet: hack frozen PySide apps down to size</a></div>
    <div><a href="https:&#x2F;&#x2F;www.rfk.id.au&#x2F;blog&#x2F;entry&#x2F;compiling-rpython-programs&#x2F;">Compiling RPython Programs</a></div>
  </div>

    </main>
  </body>
</html>